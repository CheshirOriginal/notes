До этого мы рассматривали лишь подзапросы, возвращающие один столбец. Но мы также можем работать с подзапросами, возвращающими несколько столбцов и несколько строк (производные таблицы).
## Сравнение по нескольким столбцам

SQL поддерживает сравнение не только по одной колонке, но позволяет попарно сравнивать значения в основном запросе со значениями в подзапросе.

Например, если мы хотим получить информацию о всех бронированиях, в которых цена жилья на момент брони (Reservations.price) соответствует текущей стоимостью жилья (Rooms.price). То мы это можем сделать следующим образом:

![[Pasted image 20251031165628.png]]

```sql
SELECT * FROM Reservations
    WHERE (room_id, price) IN (SELECT id, price FROM Rooms);
```

| id  | user_id | room_id | start_date               | end_date                 | price | total |
| --- | ------- | ------- | ------------------------ | ------------------------ | ----- | ----- |
| 5   | 17      | 1       | 2019-02-02T12:00:00.000Z | 2019-02-04T12:00:00.000Z | 149   | 298   |
| 6   | 14      | 2       | 2020-03-21T09:00:00.000Z | 2020-03-23T09:00:00.000Z | 225   | 450   |
| 7   | 19      | 13      | 2020-03-21T10:00:00.000Z | 2020-04-21T10:00:00.000Z | 89    | 2759  |
| 8   | 29      | 16      | 2019-06-14T10:00:00.000Z | 2019-06-24T10:00:00.000Z | 140   | 1400  |
| ... | ...     | ...     | ...                      | ...                      | ...   | ...   |

В данном примере, подзапрос возвращает таблицу с идентификаторами жилых помещений и их текущей ценой:

```sql
SELECT id, price FROM Rooms
```

| id  | price |
| --- | ----- |
| 1   | 149   |
| 2   | 225   |
| 3   | 150   |
| 4   | 89    |
| 5   | 80    |
| ... | ...   |

И затем, используя эту таблицу, мы ограничиваем все бронирования только теми, в которых пара значений room_id и price найдутся в таблице подзапроса.

Это же решение можно было бы выполнить и без сравнения по нескольким колонкам, но оно было бы более объёмным:

```sql
SELECT Reservations.* FROM Reservations
INNER JOIN Rooms
ON Reservations.room_id = Rooms.id
WHERE Reservations.price = Rooms.price;
```